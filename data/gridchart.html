
<!DOCTYPE html>
<html lang="en">

<head>
   <title>Chart</title>
   <meta content="width=device-width, initial-scale=1.0, user-scalable=yes" name="viewport">
   <link rel="stylesheet" type="text/css" href="style.css">
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>  
</head>
<body>
<div class="outer_frame">
    <h2>Grid and Battery Power</h2>
        <!-- Create a canvas element to render the chart -->
        <canvas id="myChart"></canvas>
</div>
<div class="outer_frame">
<button type="button" class="image-btn" onclick="window.location.href='index.html'"><img src="home.png">Home</button>
<button type="button" class="image-btn" onclick="window.location.href='log.html'"><img src="file-list.png">Log</button>
</div>

<script>
const canvas = document.getElementById('myChart');
canvas.height = 140;
const labels = [''];

const data = {
  labels: labels,
  datasets: [
    {
    id: 0,
    borderWidth: 2,
    pointRadius: 0,
    label: 'Grid[W]',
    backgroundColor: 'rgb(120,120,255)',
    borderColor:     'rgb(120,120,255)',
    data: [],
    tension: 0.3,
   },
   
   {
    id: 1,
    borderWidth: 1,
    pointRadius: 0, 
    label: 'Bat[W]',
    backgroundColor: 'rgb(100, 200,100)',
    borderColor: 'rgb(100,255,100)',
    data: [],
    tension: 0.3,
    fill: {below: 'rgb(50,100,50)', value: 0, above: 'rgb(100,50,50)', value: 0}
   },
  
  ]
};

const config = {
  type: 'line',
  data: data,
  options: {
     responsive: true, //It make the chart responsive
     animation: false,
       scales: {
        x: {
        grid: {
          color: 'rgb(125,125,125)',
        }
       },
        y: {
        grid: {
          lineWidth: ({ tick }) => tick.value == 0 ? 3 : 1,
          color: 'rgb(100,100,100)',
        },
        ticks:
        {
          color: 'white',
        }
       }

    }
  }
};

const myChart = new Chart(
  canvas,
  config,
);

// function to update the chart 
function addData(chart, label, data) {
  chart.data.labels.push(label);
  chart.data.datasets.forEach((dataset) => 
  {
     dataset.data.push(data);
  });
  chart.update();
}



var chartColors = {
  red: 'rgb(255, 99, 132)',
  blue: 'rgb(54, 162, 235)'
};


// function to update the chart 
function addData2(chart, label, data1,data2) 
{
  chart.data.labels.push(label);

  chart.data.datasets.forEach((dataset) => 
  {
    if (dataset.id == 0)
    {
     dataset.data.push(data1);
    }
    else
    {
     dataset.data.push(data2);
    }
  });
  
  chart.update();
}





counter = 0;
watt_grid = 0;
watt_bat  = 0;

 function reqListener () {
      var myResponse = this.responseText;
      //myResponse = myResponse.toUpperCase();
      //console.log(this.responseText);
      var myArray = myResponse.split(",");

      // test
      // myArray = ["12:00","00","0","0"];
      counter++;
     
      //console.log(myArray);
     
      if (myArray[1] != null)
      {     
        watt_grid = myArray[1];  
        watt_bat  = myArray[6];       
      }
      else
      {
        // test simulation
        watt_grid = Math.floor(Math.random() * 10) + counter;
        watt_bat    = Math.floor(Math.random() * 5) + counter;
      }
}
            
var oReq = new XMLHttpRequest();
oReq.addEventListener("load", reqListener);

setInterval(function() {
  oReq.open("GET", "/fetch");
  oReq.send();
  actTime = new Date();
  const newLabel =  actTime.getSeconds();
 
  const newVal_grid = watt_grid;
  const newVal_bat  = watt_bat;
 
  addData2(myChart, newLabel, newVal_grid, newVal_bat);
}, 1000);
        
    </script>
</body>

</html>