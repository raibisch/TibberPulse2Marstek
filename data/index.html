<!DOCTYPE HTML>
<html>
   
    <head>
        <title>%DEVICEID%</title>
        <meta content="width=device-width, initial-scale=0.8, user-scalable=yes" name="viewport">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <link rel="stylesheet" type="text/css" href="style.css">
        <meta charset="UTF-8">
        <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
        <link rel="icon" sizes="192x192" href="android-chrome-192x192.png">
        <link rel="icon" sizes="384x384" href="android-chrome-384x384.png">
        <link rel="icon" href="favicon.ico">
        <link rel="manifest" href="manifest.json">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#ffffff">
    </head>
    <body >
      <h3>%DEVICEID%</h3>
     <div class="outer_frame">
    
      <div class="outerring" id="RING_ID">
       <div class="innerring"></div>
       <div id="WATT" class="ringtext_value">---</div>
       <div class="ringtext_unit" id="UNIT">Grid [W]</div>
      <!-- <div class="ringtext_time" id="TIME">--:--</div> -->
       <div class="ringtext_status1" id="STATUS_UDP">--</div>
      <!-- <div class="ringtext_status2" id="STATUS_2">-</div> -->
     </div>
     </div>

     <div class="outer_frame">
        <table>
            <tr>
              <td  id="GRID_KWH_IN">--</td>
              <td  id="GRID_KWH_OUT">--</td>
            </tr>
            <tr>
              <th>Grid-In[kWh]</th>
              <th>Grid-Out[kWh]</th>
            </tr>
            <tr>
              <td  id="BAT_SOC">--</td>
              <td  id="BAT_WATT">--</td>
            </tr>
            <tr>
              <th>Bat SOC [%]</th>
              <th>Bat [W]</th>
            </tr>
      </table>
     </div>
     <div class="outer_frame">
     <button type="button" class="image-btn" onclick="window.location.href='gridchart.html'"><img src="chart.png">Chart</button>  
     <button type="button" class="image-btn" onclick="window.location.href='log.html'"><img src="file-list.png">Log</button>
     <button type="button" class="image-btn" onclick="window.location.href='setup.html'"><img src="settings.png">Setup</button>
     </div>
    <script type="text/javascript">
            function reqListener ()
            {
              var myResponse = this.responseText;
              //myResponse = myResponse.toUpperCase();
              //console.log(this.responseText);
              var myArray = myResponse.split(",");

              // test
              //myArray = ["12:00","00","0","0"];
              //console.log(myArray);
              var watt_grid = 0;

              if (myArray[1] != null)
              {
               //document.getElementById('TIME').innerHTML  = myArray[0]; 
               watt_grid = myArray[1];
               document.getElementById('WATT').innerHTML  = watt_grid;  

               var udpStatus = "CT connected";
               udpColor = 'green';
                document.getElementById('RING_ID').className = "outerring_blink";
               if (myArray[4] == 1)
               { 
                 udpColor = 'red';
                 udpStatus ="!no MARSTEK request!";
               }
             
               document.getElementById('STATUS_UDP').innerHTML = udpStatus;
               document.getElementById("STATUS_UDP").style.color = udpColor;

               if (watt_grid > 100)
               {
                document.getElementById('RING_ID').style.background = 'red'; 
               }
               else if (watt_grid < -100)
               {
                document.getElementById('RING_ID').style.background = 'green'; 
               }
               else
               {
                document.getElementById('RING_ID').style.background = "blue";
               }

               document.getElementById('GRID_KWH_IN').innerHTML = myArray[2];
               document.getElementById('GRID_KWH_OUT').innerHTML = myArray[3];

               document.getElementById('BAT_SOC').innerHTML = myArray[5];
               document.getElementById('BAT_WATT').innerHTML = myArray[6];

              }
            }

            var oReq = new XMLHttpRequest();
            oReq.addEventListener("load", reqListener);
            setInterval(function()
            {
              //var dateNow = new Date();  // current time
              oReq.open("GET", "/fetch");
              oReq.send();
            }, 2000); 
    </script>
    </body>
</html>
